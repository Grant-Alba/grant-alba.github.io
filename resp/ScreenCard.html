<div id="main">
        
        <div id="editor-view" class="view-container visible">
            <div id="empty-state" style="text-align: center; opacity: 0.5; margin-top: 100px;">
                <h3>Select or Create a Scene</h3>
            </div>
            
            <div id="editor" class="editor-card hidden">
                <div style="float: right; font-size: 1.1em; font-weight: bold; color: var(--accent);" id="screen-time-estimate"></div>
                
                <div class="field-group">
                    <label>Scene Header</label>
                    <input type="text" id="inp-header" placeholder="EXT. LOCATION - TIME or MONTAGE - TYPE" oninput="updateHeader(this.value);">
                </div>
                <div class="field-group">
                    <label>Location (Auto-Extracted)</label>
                    <input type="text" id="inp-location" placeholder="POLICE STATION" oninput="updateCurrentCard('location', this.value);">
                </div>

                <div class="meta-grid" style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">
                    <div class="field-group">
                        <label>Characters</label>
                        <input type="text" id="inp-chars" list="character-list" placeholder="Bubba, Sheriff..." oninput="updateCurrentCard('chars', this.value)">
                    </div>
                    <div class="field-group">
                        <label>Props</label>
                        <input type="text" id="inp-props" placeholder="Red Car..." oninput="updateCurrentCard('props', this.value)">
                    </div>
                </div>
                <div class="field-group">
                    <label>Opening Action / Scene Notes</label>
                    <textarea rows="4" id="inp-notes" placeholder="Describe initial action..." oninput="updateCurrentCard('notes', this.value)"></textarea>
                </div>
                <div class="field-group">
                    <label>Tags</label>
                    <input type="text" id="inp-tags" placeholder="Flashback, Montage..." oninput="updateCurrentCard('tags', this.value)">
                </div>
                <hr style="border:0; border-top:1px solid var(--border); margin:20px 0;">

                <div id="montage-editor-block" class="hidden">
                    <label>Montage Elements (Drag to reorder)</label>
                    <ul id="montageList" style="list-style: none; padding: 0; margin: 5px 0;"></ul>
                    <button onclick="addMontageItem()" style="margin-top:10px; cursor:pointer;">+ Add Montage Item</button>
                    <hr style="border:0; border-top:1px solid var(--border); margin:20px 0;">
                </div>
                
                <div id="sequence-editor-block">
                    <label>Dialogue and Inter-Dialogue Action Sequence</label>
                    <table class="sequence-table">
                        <thead><tr><th width="25%">Character / Action</th><th width="15%">Context / Style</th><th>Dialogue / Action Content</th><th width="5%"></th></tr></thead>
                        <tbody id="sequenceBody"></tbody>
                    </table>
                    <button onclick="addSequenceItem('Character')" style="margin-top:10px; cursor:pointer;">+ Add Dialogue Line</button>
                    <button onclick="addSequenceItem('Action', null, 'TITLE CARD')" style="margin-top:10px; cursor:pointer;">+ Add Title Card</button>
                    <button onclick="addSequenceItem('Action')" style="margin-top:10px; cursor:pointer;">+ Add Action Block</button>
                </div>

                <button onclick="deleteCurrentCard()" style="float:right; margin-top:10px; color:red; cursor:pointer;">Delete</button>
            </div>
        </div>

        <script>
        // ... (Existing state and init code) ...

        function saveData() {
            localStorage.setItem('screenplayData', JSON.stringify(cards));
            localStorage.setItem('scriptMetadata', JSON.stringify(scriptMetadata));
            updateCharacterList();
            if(currentView === 'editor') {
                renderList();
                if(activeCardId) updateScreenTimeEstimate(); // CALL THE NEW ESTIMATOR
            }
        }

        function loadEditor(id) {
            activeCardId = id;
            const card = cards.find(c => c.id === id);
            
            if (!card) {
                document.getElementById('editor').classList.add('hidden');
                document.getElementById('empty-state').classList.remove('hidden');
                document.getElementById('screen-time-estimate').innerHTML = ''; // Clear estimate
                return;
            }

            document.getElementById('empty-state').classList.add('hidden');
            document.getElementById('editor').classList.remove('hidden');
            ['header', 'location', 'chars', 'props', 'notes', 'tags'].forEach(f => document.getElementById('inp-' + f).value = card[f]);
            
            toggleMontageEditor(card.header); 
            
            if (card.header.toUpperCase().startsWith('MONTAGE')) {
                renderMontageList(card.montage || []);
            } else {
                renderSequenceTable(card.sequence || []);
            }
            
            renderList();
            updateScreenTimeEstimate(); // INITIAL ESTIMATE ON LOAD
        }
        
        // --- NEW TIME ESTIMATION FUNCTIONS ---

        function countWords(text) {
            if (!text || typeof text !== 'string') return 0;
            return text.trim().split(/\s+/).filter(word => word.length > 0).length;
        }

        function estimateScreenTime(card) {
            if (!card) return 0;

            // Average word-to-page ratios (words per page equivalent):
            const ACTION_WORDS_PER_PAGE = 250; 
            const DIALOGUE_WORDS_PER_PAGE = 130; 
            const LINES_PER_PAGE = 55;

            let pageEquivalent = 0;
            let totalActionWords = 0;
            let totalDialogueWords = 0;

            // 1. Scene Header (1 line + 1 blank line)
            pageEquivalent += (2 / LINES_PER_PAGE); 
            
            // 2. Opening Action / Notes
            totalActionWords += countWords(card.notes);

            // 3. Sequence Analysis
            card.sequence.forEach(s => {
                if (s.type === 'Action') {
                    totalActionWords += countWords(s.text);
                    
                    // Add a small fixed cost for the ACTION: label and blank lines (approx 2 lines)
                    pageEquivalent += (2 / LINES_PER_PAGE); 
                } else if (s.type === 'Character') {
                    totalDialogueWords += countWords(s.text);
                    
                    // Parentheticals/Context take up space, treat as action words
                    totalActionWords += countWords(s.parenthetical);
                    totalActionWords += countWords(s.context.replace(/[()]/g, ''));

                    // Add a small fixed cost for the CHARACTER NAME and blank lines (approx 2 lines)
                    pageEquivalent += (2 / LINES_PER_PAGE); 
                }
            });

            // 4. Montage Analysis
            if (card.header.toUpperCase().startsWith('MONTAGE')) {
                // Montages use dense action lines (e.g., 1 line per beat + blank line)
                // Assuming 2 lines per montage item, or 27 items per page
                pageEquivalent += (card.montage.length / 27); 
            }

            // 5. Convert Words to Page Equivalent (Weighted)
            const actionPages = totalActionWords / ACTION_WORDS_PER_PAGE; 
            const dialoguePages = totalDialogueWords / DIALOGUE_WORDS_PER_PAGE; 
            
            pageEquivalent += actionPages + dialoguePages;

            // Round the estimate to the nearest tenth of a minute
            return Math.max(0.1, Math.round(pageEquivalent * 10) / 10);
        }

        function updateScreenTimeEstimate() {
            const card = cards.find(c => c.id === activeCardId);
            if (!card) return;
            const time = estimateScreenTime(card);
            document.getElementById('screen-time-estimate').innerHTML = `⏱️ Est. Time: ${time} min`;
        }
        
        // --- EXISTING SEQUENCE AND MONTAGE UPDATE FUNCTIONS (modified to call updateScreenTimeEstimate) ---
        
        function updSeq(i, f, v) { 
            const item = cards.find(c => c.id === activeCardId).sequence[i];
            
            if (f === 'content' || f === 'text' || f === 'parenthetical' || f === 'context' || f === 'style') {
                item[f] = v;
            } else if (f === 'contd') { 
                item.contd = v; 
            }

            saveData(); 
            updateScreenTimeEstimate(); // UPDATE
        }

        function addSequenceItem(type, index = null, style = '') { 
            const card = cards.find(c => c.id === activeCardId);
            const newItem = type === 'Character' 
                ? { type: 'Character', content: '', context: '', contd: false, parenthetical: '', text: '' }
                : { type: 'Action', style: style, text: '' }; 
            
            if (index !== null) {
                card.sequence.splice(index, 0, newItem);
            } else {
                card.sequence.push(newItem);
            }
            
            saveData(); 
            renderSequenceTable(card.sequence);
            updateScreenTimeEstimate(); // UPDATE
        }

        function delSeq(i) { 
            cards.find(c => c.id === activeCardId).sequence.splice(i, 1); 
            saveData(); 
            renderSequenceTable(cards.find(c => c.id === activeCardId).sequence); 
            updateScreenTimeEstimate(); // UPDATE
        }
        
        function updMontageItem(i, v) { 
            cards.find(c => c.id === activeCardId).montage[i] = v; 
            saveData(); 
            updateScreenTimeEstimate(); // UPDATE
        }

        function addMontageItem() { 
            cards.find(c => c.id === activeCardId).montage.push(''); 
            saveData(); 
            renderMontageList(cards.find(c => c.id === activeCardId).montage); 
            updateScreenTimeEstimate(); // UPDATE
        }
        
        function delMontageItem(i) { 
            cards.find(c => c.id === activeCardId).montage.splice(i, 1); 
            saveData(); 
            renderMontageList(cards.find(c => c.id === activeCardId).montage); 
            updateScreenTimeEstimate(); // UPDATE
        }
        
        function swapMontageItems(fromIndex, toIndex) {
            const montage = cards.find(c => c.id === activeCardId).montage;
            const item = montage[fromIndex];
            montage.splice(fromIndex, 1);
            montage.splice(toIndex, 0, item);
            saveData();
            renderMontageList(montage);
            updateScreenTimeEstimate(); // UPDATE
        }
        
        // ... (The rest of the script remains the same) ...
    </script>
</body>
</html>
